<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Admin Dash</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="../../src/css/adminDash.css">
  </head>
  <body>
    <div id="userFeedbackDetailsModal">
      <div id="userFeedbackDetailsModalContent">
        <textarea id="userFeedbackMessageText" readonly></textarea>
        <div id="scanLeaveConfirmationForm">
            <select id="userFeedbackStatusChangeSelect">
              <option value="Undealt">Undealt</option>
              <option value="Responded">Responded</option>
            </select>
            <button id="userFeedbackSaveStatusButton" class="prevent-select">Save</button>
            <button id="userFeedbackCancelStatusChangeButton" class="prevent-select">Cancel</button>
        </div>
      </div>
    </div>

    <div id="adminDashContainer">
      <div class="largeSectionGroup">
        <h1 class="adminDashLargeSectionTitle">Site Settings</h1>
        <div class="adminDashLargeSection" id="adminDashSettingsSection">
          <div id="configAndStatusBlackBox">
            <span id="WelcomeAdminText">Welcome Admin!</span>
            <div id="currentConfigurationsContainer" class="blackBoxTextGroup">
              <span>Current Configurations:</span>
              <span id="scanSecondsLimitText">&nbsp;&nbsp;Scan Seconds Limit: 120</span>
              <span id="maxScansPerDayText">&nbsp;&nbsp;Max Scans Per Day: 3</span>
              <span id="demoModeText">&nbsp;&nbsp;Demo Mode Status: false</span>
            </div>
            <div id="previousLoginLocationContainer" class="blackBoxTextGroup">
              <span>Previous Login Location:</span>
              <span>&nbsp;&nbsp;London, Ontario, Canada</span>
            </div>
            <div id="dailySiteStatsContainer" class="blackBoxTextGroup">
              <span>24 Hour Site Stats:</span>
              <span>&nbsp;&nbsp;Users Queued: </span>
              <span>&nbsp;&nbsp;Scans Attempted: </span>
              <span>&nbsp;&nbsp;Alerts Found: </span>
              <span>&nbsp;&nbsp;Queue Auto Corrections: </span>
              <span>&nbsp;&nbsp;Scan Cancels: </span>
              <span>&nbsp;&nbsp;Completed Scans: </span>
            </div>
            <button id="siteStatsRefreshButton" class="submit-button">Refresh Stats</button>
          </div>
          <div id="scanConfigurationInputsPortion">
            <form id="scanConfigForm">
              <div class="formInputGroup">
                <label for="scanSecondsLimitInput">New Scan Seconds Limit:</label>
                <input min="0" class="scanConfigNumberInput" type="number" id="scanSecondsLimitInput" name="scanSecondsLimitInput">
              </div>

              <div class="formInputGroup">
                <label for="maxScansPerDayInput">New Max Scans Per Day:</label>
                <input min="0" class="scanConfigNumberInput" type="number" id="maxScansPerDayInput" name="maxScansPerDayInput">
              </div>

              <div class="formInputGroup">
                <label for="demoModeSelect">Demo Mode Status:</label>
                <select id="demoModeSelect">
                  <option value="true">true</option>
                  <option value="false">false</option>
                </select>
              </div>

              <div class="formInputGroup">
                <label for="confirmConfigChangesInput">Confirm Changes: </label>
                <input type="checkbox" id="confirmConfigChangesInput" name="confirmConfigChangesInput" required>
              </div>

              <div id="scanConfigButtonsContainer" class="formInputGroup">
                <input id="scanConfigurationSubmitButton" class="submit-button" type="submit" value="Submit" disabled>
                <button id="scanConfigurationCancelButton" class="cancel-button" disabled>Cancel</button>
              </div>
            </form>
          </div>

          <div id="motdEditorPortion">
            <form id="scanMOTDForm">
              <span>Message of the Day HTML Editor</span>
              <textarea id="motdEditorTextArea"></textarea>

              <div class="formInputGroup">
                <label for="confirmMOTDChangesInput">Confirm Changes: </label>
                <input type="checkbox" id="confirmMOTDChangesInput" name="confirmMOTDChangesInput" required>
              </div>

              <div class="formInputGroup">
                <button id="motdEditorRevertButton" class="cancel-button" disabled>Revert</button>
                <input id="motdEditorSubmitButton" class="submit-button" type="submit" value="Save MOTD" disabled>
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="largeSectionGroup">
        <h1 class="adminDashLargeSectionAnalyticsTitle">Analytics Viewer</h1>
        <div id="adminDashAnalyticsSection">
          <div id="graphViewSelectorContainer">
            <div>Select Graph Stat:</div>
            <select id="selectGraphSelect">
              <option>Graph Views</option>
              <option>Hourly Total Scans VS Last 24 Hours</option>
              <option>View 2</option>
              <option>View 3</option>
              <option>View 4</option>
            </select>
            <div>Select Date:</div>
            <select id="selectDateSelect">
              <option>03/2022</option>
              <option>04/2022</option>
              <option>05/2022</option>
              <option>06/2022</option>
              <option>07/2022</option>
            </select>
            <button id="dataAnalyticsQueryButton">Query</button>
          </div>
          <div id="AdminAnalyticsGraphContainer"><canvas id="AdminAnalyticsGraph"></canvas></div>
        </div>
      </div>

      <div class="largeSectionGroup">
        <h1 class="adminDashLargeSectionAnalyticsTitle">User Feedback</h1>
        <div id="adminDashAnalyticsSection">
          <div class="table-wrap">
            <table class="sortable">
              <caption>
                Site Statistics Over Time
                <span class="sr-only">, column headers with buttons are sortable.</span>
              </caption>
              <thead id="statsTableHeader">
                <tr>
                  <th aria-sort="descending">
                    <button>
                      Date
                      <span aria-hidden="true"></span>
                    </button>
                  </th>
                  <th>
                    <button>
                      Email
                      <span aria-hidden="true"></span>
                    </button>
                  </th>
                  <th>
                    <button>
                      Status
                      <span aria-hidden="true"></span>
                    </button>
                  </th>
                  <th class="no-sort">Tools</th>
                </tr>
              </thead>
              <tbody id="feedbackSystemTBody">
                <tr>
                  <td>3/18/2024, 6:46:24 AM</td>
                  <td>example@email.com</td>
                  <td>Undealt</td>
                  <td><button>Details</button></td>
                </tr>
                <tr>
                  <td>3/18/2024, 6:56:24 AM</td>
                  <td>example1@email.com</td>
                  <td>Responded</td>
                  <td><button>Details</button></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <script src="../../src/js/adminDash.js"></script>
    <script src="../../src/js/sortableTable.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const lineColor = getComputedStyle(document.documentElement).getPropertyValue('--background-color');
      let ctx = document.getElementById('AdminAnalyticsGraph');
      ctx.style.display="none"
      let analyticsQueryButton = document.getElementById("dataAnalyticsQueryButton")

      let analyticsChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: '# of Scans Performed',
            data: [],
            borderWidth: 1,
            borderColor: lineColor
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true
            }
          },
          elements: {
            canvas: {
                backgroundColor: '#000000' // Background color
            }
          }
        }
      });

      function retrieveAnalyticsViewFromBackend(){
        let selectedDate = selectDateSelect.value
        let selectedColumn = selectGraphSelect.value

        if (selectedDate != "" && selectedColumn != ""){
            console.log("Getting Analytics View From Database")
            fetch("http://localhost:3030/get-sql-view", {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                "username": attemptedUsername,
                "loginToken": attemptedToken,
                "date": selectedDate,
                "column": selectedColumn
            })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                };

                return response.json();
            })
            .then(data => {  
                console.log(data)
                ctx.style.display=""
                let view = data["view"]
                let viewDates = []
                let viewValues = []

                view.forEach(row => {
                  let formattedDate = (row["date"]).split("T")
                  formattedDate = formattedDate[0]
                  viewDates.push(formattedDate)
                  viewValues.push(row[selectedColumn])
                });

                analyticsChart.data.datasets[0].data = viewValues;
                analyticsChart.data.labels = viewDates;
                analyticsChart.update();
            })
            .catch(error => {
                console.error('Fetch error:', error.message);
            });
        }
      }

      analyticsQueryButton.addEventListener("click", retrieveAnalyticsViewFromBackend)
    </script>
  </body>
</html>